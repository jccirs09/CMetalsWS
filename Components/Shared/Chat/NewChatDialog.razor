@using CMetalsWS.Data
@using CMetalsWS.Services
@using MudBlazor

@inject UserService UserService
@inject NavigationManager Nav

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">New Chat</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_searchQuery"
                      Placeholder="Search for people..."
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Immediate="true"
                      DebounceInterval="200"
                      OnDebounceIntervalElapsed="SearchUsers"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" />

        <MudList T="ApplicationUser" Clickable="true" Class="mt-3" Style="max-height: 400px; overflow-y: auto;">
            @if (_users.Any())
            {
                foreach (var user in _users)
                {
                    <MudListItem T="ApplicationUser" OnClick="() => StartChat(user)">
                        <ChildContent>
                            <MudAvatar>@GetInitials(user)</MudAvatar>
                            <MudText Class="ml-3">@GetDisplayName(user)</MudText>
                        </ChildContent>
                    </MudListItem>
                }
            }
            else
            {
                <MudListItem T="ApplicationUser">
                    <MudText Class="mud-text-secondary">No users found.</MudText>
                </MudListItem>
            }
        </MudList>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    private string _searchQuery = string.Empty;
    private List<ApplicationUser> _allUsers = new();
    private List<ApplicationUser> _users = new();

    protected override async Task OnInitializedAsync()
    {
        _allUsers = (await UserService.GetUsersAsync()).ToList();
        _users = _allUsers;
    }

    private async Task SearchUsers(string query)
    {
        _searchQuery = query;
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            _users = _allUsers;
        }
        else
        {
            _users = _allUsers
                .Where(u =>
                    (u.UserName != null && u.UserName.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)) ||
                    (u.FirstName != null && u.FirstName.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)) ||
                    (u.LastName != null && u.LastName.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)) ||
                    (GetDisplayName(u).Contains(_searchQuery, StringComparison.OrdinalIgnoreCase))
                )
                .ToList();
        }
        await InvokeAsync(StateHasChanged);
    }

    private void StartChat(ApplicationUser user)
    {
        MudDialog.Close(DialogResult.Ok(user.Id));
    }

    private void Cancel() => MudDialog.Cancel();

    private string GetDisplayName(ApplicationUser user)
    {
        var fullName = $"{user.FirstName} {user.LastName}".Trim();
        return string.IsNullOrWhiteSpace(fullName) ? user.UserName ?? "Unknown" : fullName;
    }

    private string GetInitials(ApplicationUser user)
    {
        var name = GetDisplayName(user);
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length > 1 ? $"{parts[0][0]}{parts[1][0]}".ToUpper() : $"{name[0]}".ToUpper();
    }
}