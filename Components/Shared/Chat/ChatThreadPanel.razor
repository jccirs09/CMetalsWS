@using CMetalsWS.Data.Chat
@using CMetalsWS.Services
@using CMetalsWS.Services.SignalR
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using System.Security.Claims

@inject IChatRepository ChatRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject ChatStateService ChatState
@inject ChatHubClient ChatHubClient

@implements IAsyncDisposable

<div class="d-flex flex-column">
    <MudTextField @bind-Value="_searchQuery"
                  Placeholder="Search messages..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="Refresh" />

    <div class="thread-viewport">
        <MudList T="ThreadSummary" Clickable="true" Dense="true">
            <Virtualize TItem="ThreadSummary" ItemsProvider="LoadThreads" Context="t" ItemSize="72" OverscanCount="3" @ref="_virt" @key="_currentUserId">
                <ItemContent>
                    <MudListItem T="ThreadSummary" OnClick="@(() => OnThreadSelected.InvokeAsync(t))"
                                 Class="@(ChatState.ActiveThreadId == t.Id ? "mud-selected-item mud-primary-text mud-primary-hover" : "")">

                        <MudAvatar>
                            @if (!string.IsNullOrWhiteSpace(t.AvatarUrl))
                            {
                                <MudImage Src="@t.AvatarUrl" />
                            }
                            else
                            {
                                <span class="mud-typography-h6">@GetInitials(t.FullName)</span>
                            }
                        </MudAvatar>

                        <div class="ml-4 flex-grow-1">
                            <MudText Typo="Typo.subtitle2" Style="font-weight: bold;">@t.FullName</MudText>
                            <MudText Typo="Typo.caption" Style="@(t.UnreadCount > 0 ? "font-weight: bold;" : "")">@t.LastMessagePreview</MudText>
                        </div>

                        <MudIconButton Icon="@(t.IsPinned? Icons.Material.Filled.PushPin : Icons.Material.Outlined.PushPin)"
                                       Color="@(t.IsPinned ? Color.Primary : Color.Default)"
                                       OnClick="@(() => PinThread(t))" />
                    </MudListItem>
                </ItemContent>
            </Virtualize>
        </MudList>
    </div>
</div>

@if (_providerRan && _lastCount == 0)
{
    <div class="pa-3">
        <MudText Typo="Typo.caption" Class="mud-text-secondary">No conversations found.</MudText>
    </div>
}

@code {
    [Parameter] public EventCallback<ThreadSummary> OnThreadSelected { get; set; }

    private string _searchQuery = string.Empty;
    private string? _currentUserId;

    private Virtualize<ThreadSummary>? _virt;
    private bool _providerRan;
    private int _lastCount;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var u = authState.User;
        _currentUserId = u.FindFirstValue(ClaimTypes.NameIdentifier);
        ChatState.OnChange += StateHasChanged;
        ChatHubClient.ThreadsUpdated += OnThreadsUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _virt != null)
        {
            await _virt.RefreshDataAsync();
        }
    }

    private async Task Refresh()
    {
        if (_virt != null) await _virt.RefreshDataAsync();
    }

    private async Task OnThreadsUpdated()
    {
        await Refresh();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PinThread(ThreadSummary thread)
    {
        await ChatHubClient.PinThreadAsync(thread.Id!, !thread.IsPinned);
        await Refresh();
    }

    private async ValueTask<ItemsProviderResult<ThreadSummary>> LoadThreads(ItemsProviderRequest request)
    {
        _providerRan = true;
        if (string.IsNullOrEmpty(_currentUserId))
            return new ItemsProviderResult<ThreadSummary>(Array.Empty<ThreadSummary>(), 0);

        var all = (await ChatRepository.GetThreadSummariesAsync(_currentUserId, _searchQuery)).ToList();
        _lastCount = all.Count;

        var page = all.Skip(request.StartIndex).Take(request.Count);
        return new ItemsProviderResult<ThreadSummary>(page, all.Count);
    }

    private string GetInitials(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "?";
        var parts = fullName.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        return parts.Length > 1 ? $"{parts[0][0]}{parts[1][0]}".ToUpper() : $"{parts[0][0]}".ToUpper();
    }

    public ValueTask DisposeAsync()
    {
        ChatState.OnChange -= StateHasChanged;
        ChatHubClient.ThreadsUpdated -= OnThreadsUpdated;
        return ValueTask.CompletedTask;
    }
}

<style>
    .thread-viewport {
        height: calc(100vh - 220px);
        overflow: auto;
    }
</style>
