:root {
  --bg: var(--mud-palette-background);
  --bg-elev: var(--mud-palette-surface);
  --panel: var(--mud-palette-surface);
  --text: var(--mud-palette-text-primary);
  --muted: var(--mud-palette-text-secondary);
  --primary: var(--mud-palette-primary);
  --incoming: var(--mud-palette-surface);
  --outgoing: var(--mud-palette-primary);
  --incoming-text: var(--mud-palette-text-primary);
  --outgoing-text: var(--mud-palette-primary-text);
  --divider: var(--mud-palette-lines-default);
  --radius-xl: 18px;
  --shadow: 0 4px 12px rgba(0,0,0,.2);
}

.chat {
  display: grid;
  grid-template-rows: auto 1fr auto;
  width: min(92vw, 420px);
  height: min(70dvh, 560px);
  background: var(--bg-elev);
  border: 1px solid var(--divider);
  border-radius: 16px;
  overflow: hidden;
}

.chat-float { position: fixed; right: 16px; bottom: 16px; z-index: 1200; }
.chat-fab { position: fixed; right: 16px; bottom: 16px; z-index: 1199; }
@media (max-width: 640px){ .chat-float { left: 8px; right: 8px; bottom: 8px; } }

.chat__header {
  display:flex; align-items:center; gap:12px; padding:14px 16px;
  border-bottom: 1px solid var(--divider);
  position: sticky; top: 0; z-index: 2; background: var(--bg-elev);
}
.chat__name { font-weight: 600; color: var(--text); }
.chat__status { font-size: 12px; color: var(--muted); }

.chat__messages {
  overflow: auto; padding: 16px; display: grid; gap: 8px; align-content: start;
  -webkit-overflow-scrolling: touch;
}

.day-divider, .unread-divider {
  display:grid; grid-template-columns: 1fr auto 1fr; gap:8px; align-items:center;
  color: var(--muted); font-size: 12px; user-select: none; margin: 8px 0;
}
.day-divider::before, .day-divider::after,
.unread-divider::before, .unread-divider::after { content: ""; height:1px; background: var(--divider); }
.unread-divider span { color: var(--primary); font-weight:600; }

.message { display:flex; gap:10px; }
.message__avatar { align-self: flex-end; }
.bubble {
  max-width: min(78ch, 70%);
  padding: 10px 12px; border-radius: var(--radius-xl);
  position: relative; box-shadow: var(--shadow);
  word-wrap: break-word; white-space: pre-wrap;
  font-size: 16px; /* prevent iOS zoom */
}
.in .bubble { background: var(--incoming); color: var(--incoming-text); border-bottom-left-radius: 6px; }
.out { justify-content: flex-end; }
.out .bubble { background: var(--outgoing); color: var(--outgoing-text); border-bottom-right-radius: 6px; }

.in .bubble::after, .out .bubble::after {
  content: ""; position:absolute; bottom:0; width:10px; height:10px; clip-path: polygon(0 0, 100% 100%, 0 100%);
}
.in .bubble::after { left:-6px; background: var(--incoming); box-shadow: -2px 2px 2px rgba(0,0,0,.06); }
.out .bubble::after { right:-6px; background: var(--outgoing); box-shadow: 2px 2px 2px rgba(0,0,0,.12); }

.meta-row { display:flex; gap:10px; align-items:center; margin-top: 4px; }
.time { color: var(--muted); font-size: 12px; }
.reaction { font-size:12px; padding:2px 6px; border-radius:12px; background: rgba(255,255,255,.04); border: 1px solid var(--divider); }
.seen { color: var(--muted); font-size: 12px; }

.message.compact { gap:6px; }
.message.compact .message__avatar { visibility: hidden; }
.message.compact .bubble { margin-top: -2px; }

.typing { display:flex; gap:8px; align-items:flex-end; min-height:36px; }
.dots { background: var(--incoming); color: var(--incoming-text); border-radius: var(--radius-xl); padding:8px 12px; }
.dot { display:inline-block; width:6px; height:6px; border-radius:50%; background: currentColor; opacity:.65; animation: blink 1s infinite; }
.dot:nth-child(2){ animation-delay: .2s; }
.dot:nth-child(3){ animation-delay: .4s; }
@keyframes blink { 0%, 80%, 100%{ transform: translateY(0); opacity:.4 } 40%{ transform: translateY(-3px); opacity:1 } }

.composer { display:grid; grid-template-columns: auto 1fr auto; gap:10px; padding:12px 16px calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--divider); background: var(--bg-elev); }
.btn { border: 1px solid var(--divider); border-radius: 12px; min-height:44px; min-width:44px; }
.input { border: 1px solid var(--divider); background: var(--panel); color: var(--text); border-radius: 14px; font-size:16px; }
.send { border-radius: 14px; min-height:44px; min-width:44px; }

@media (max-width: 640px){
  .chat__header { padding: 10px 12px; }
  .composer { gap:8px; padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
  .bubble { max-width: 88%; padding: 9px 10px; }
}
