@using CMetalsWS.Data
@using CMetalsWS.Data.Chat
@inject IChatRepository ChatRepository
@inject IChatService ChatService
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims

<MudPaper Class="chat-threads-panel" Elevation="8" Style="width:360px;max-height:70vh;overflow:auto;">
  <MudToolBar Dense="true">
    <MudText Typo="Typo.subtitle1">Chats</MudText>
    <MudSpacer />
    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="OnClose" />
  </MudToolBar>

  <MudTextField @bind-Value="_q"
                Placeholder="Search people, groups, messages"
                Adornment="Adornment.Start"
                AdornmentIcon="@Icons.Material.Filled.Search"
                Immediate="true"
                OnKeyUp="@(_ => DebounceSearch())"
                Class="ma-2" />

  <MudTabs>
    <MudTabPanel Text="Recent">
      <MudVirtualize Items="_recentConversations" ItemSize="56" Context="context" T="ThreadSummary">
        <ChildContent>
          <MudListItem T="ThreadSummary" OnClick="() => OnConversationSelected.InvokeAsync(context)">
            <ChildContent>
              <MudAvatar />
              <div class="ml-4">
                <MudText>@context.Title</MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary mud-truncate">@context.LastMessagePreview</MudText>
              </div>
            </ChildContent>
          </MudListItem>
        </ChildContent>
      </MudVirtualize>
    </MudTabPanel>

    <MudTabPanel Text="People">
      <MudVirtualize Items="_people" ItemSize="56" Context="context" T="ApplicationUser">
        <ChildContent>
          <MudListItem T="ApplicationUser" OnClick="() => StartUserConversation(context)">
            <MudAvatar /><MudText Class="ml-3">@context.UserName</MudText>
          </MudListItem>
        </ChildContent>
      </MudVirtualize>
    </MudTabPanel>

    <MudTabPanel Text="Groups">
      <MudVirtualize Items="_groups" ItemSize="56" Context="context" T="ChatGroup">
        <ChildContent>
          <MudListItem T="ChatGroup" OnClick="() => StartGroupConversation(context)">
            <MudAvatar Icon="@Icons.Material.Filled.Group" /><MudText Class="ml-3">@context.Name</MudText>
          </MudListItem>
        </ChildContent>
      </MudVirtualize>
    </MudTabPanel>
  </MudTabs>
</MudPaper>

@code {
  [Parameter] public EventCallback OnClose { get; set; }
  [Parameter] public EventCallback<ThreadSummary> OnConversationSelected { get; set; }

  private string _q = string.Empty;
  private System.Timers.Timer? _searchDebounce;
  private List<ApplicationUser> _people = new();
  private List<ChatGroup> _groups = new();
  private List<ThreadSummary> _recentConversations = new();
  private string? _currentUserId;

  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    _currentUserId = authState.User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier);
    if (_currentUserId != null)
        _recentConversations = (await ChatRepository.GetThreadSummariesAsync(_currentUserId))?.ToList() ?? new();
  }

  private void DebounceSearch() {
    _searchDebounce ??= new System.Timers.Timer(250) { AutoReset = false };
    _searchDebounce.Stop();
    _searchDebounce.Elapsed -= OnSearchElapsed;
    _searchDebounce.Elapsed += OnSearchElapsed;
    _searchDebounce.Start();
  }

  private async void OnSearchElapsed(object? s, System.Timers.ElapsedEventArgs e) {
    var q = _q?.Trim();
    if (string.IsNullOrEmpty(q)) {
      await InvokeAsync(() => { _people.Clear(); _groups.Clear(); StateHasChanged(); });
      return;
    }
    var users = await ChatService.SearchUsersAsync(q, take: 30);
    var groups = await ChatService.SearchGroupsAsync(q, take: 30);
    await InvokeAsync(() => { _people = users; _groups = groups; StateHasChanged(); });
  }

  private void StartUserConversation(ApplicationUser user) { }
  private void StartGroupConversation(ChatGroup group) { }
}
