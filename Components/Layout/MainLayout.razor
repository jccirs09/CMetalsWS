@inherits LayoutComponentBase

<MudThemeProvider Theme="_customTheme" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="2" Class="z-appbar">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" OnClick="@(()=>_drawerOpen=!_drawerOpen)" />
        <MudText Typo="Typo.h5" Class="ml-3">Application</MudText>
        <MudSpacer />
        <MudIconButton @ref="_messagesBtnRef"
                       Icon="@Icons.Material.Filled.Message"
                       AriaLabel="Open messages"
                       OnClick="@ToggleChatThreadsPanel" />
        <MudIconButton Icon="@Icons.Material.Filled.Notifications" />
        <MudMenu Icon="@Icons.Material.Filled.Person">
            <MudMenuItem Link="/profile">Profile</MudMenuItem>
            <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>

    <MudMainContent Class="pt-16 pa-4">
        @Body
    </MudMainContent>

</MudLayout>

<MudPopover Open="_isChatThreadsPanelOpen"
            Class="z-chat-popover"
            AnchorReference="PopoverAnchorReference.Element"
            AnchorEl="_messagesBtnRef?.Ref"
            AnchorOrigin="Origin.BottomRight"
            TransformOrigin="Origin.TopRight"
            Fixed="true"
            CloseOnOutsideClick="true"
            OnClose="ToggleChatThreadsPanel">
    <ChatThreadsPanel OnClose="ToggleChatThreadsPanel"
                      OnConversationSelected="OpenChatWindowFromConversation" />
</MudPopover>

<div class="chat-dock-host">
    @for (var i = 0; i < _openChatThreads.Count; i++)
    {
        var thread = _openChatThreads[i];
        <ChatThreadWindow ThreadUser="@thread.User"
                          ThreadGroup="@thread.Group"
                          Title="@thread.Title"
                          IsMinimized="@thread.IsMinimized"
                          OnClose="() => CloseChatWindow(thread)"
                          OnMinimize="() => MinimizeChatWindow(thread)" />
    }
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>
