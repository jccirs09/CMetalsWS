@using MudBlazor
@using CMetalsWS.Data
@using CMetalsWS.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject WorkOrderService WorkOrderService
@inject AuthenticationStateProvider AuthStateProvider
@inject TaskAuditEventService AuditEventService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Work Order: @(_workOrder?.WorkOrderNumber)</MudText>
    </TitleContent>
    <DialogContent>
        @if (_workOrder == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <MudText><b>Tag Number:</b> @_workOrder.TagNumber</MudText>
                </MudItem>

                @foreach(var item in _workOrder.Items)
                {
                    <MudItem xs="12"><MudDivider /></MudItem>
                    <MudItem xs="12">
                        <MudText><b>Description:</b> @item.Description</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText><b>Sales Order:</b> @item.SalesOrderNumber</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText><b>Customer:</b> @item.CustomerName</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudText><b>Quantity:</b> @item.OrderQuantity</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudText><b>Weight:</b> @item.OrderWeight</MudText>

                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudText><b>Width:</b> @item.Width</MudText>
                    </MudItem>

                    @if (MachineCategory == MachineCategory.CTL)
                    {
                        <MudItem xs="12" sm="3">
                            <MudText><b>Length:</b> @item.Length</MudText>
                        </MudItem>
                    }
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
        <AuthorizeView Roles="Planner, Supervisor, Manager, Admin">
            <MudButton Color="Color.Secondary" OnClick="Edit">Edit</MudButton>
        </AuthorizeView>
        <AuthorizeView Roles="Operator">
            <MudButton Color="Color.Primary" OnClick="Process">Process</MudButton>
        </AuthorizeView>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public int WorkOrderId { get; set; }
    [Parameter] public MachineCategory MachineCategory { get; set; }

    private WorkOrder? _workOrder;

    protected override async Task OnInitializedAsync()
    {
        _workOrder = await WorkOrderService.GetByIdAsync(WorkOrderId);
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.Identity?.Name ?? "Unknown";
        await AuditEventService.CreateAuditEventAsync(WorkOrderId, TaskType.WorkOrder, AuditEventType.Start, userId, $"Work Order Details Viewed.");
    }

    private async Task Edit()
    {
        if (_workOrder is null) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.Identity?.Name ?? "Unknown";
        await AuditEventService.CreateAuditEventAsync(WorkOrderId, TaskType.WorkOrder, AuditEventType.Start, userId, $"Work Order opened for editing.");

        var parameters = new DialogParameters
        {
            ["Model"] = _workOrder,
            ["IsEdit"] = true,
            ["IsProcessing"] = false,
            ["Title"] = $"Edit Work Order: {_workOrder.WorkOrderNumber}"
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };

        var dialog = await DialogService.ShowAsync<CMetalsWS.Components.Pages.Operations.WorkOrder.WorkOrderDialog>("Edit Work Order", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private async Task Process()
    {
        if (_workOrder is null) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.Identity?.Name ?? "Unknown";
        await AuditEventService.CreateAuditEventAsync(WorkOrderId, TaskType.WorkOrder, AuditEventType.Start, userId, $"Work Order opened for processing.");

        var parameters = new DialogParameters
        {
            ["Model"] = _workOrder,
            ["IsEdit"] = false,
            ["IsProcessing"] = true,
            ["Title"] = $"Process Work Order: {_workOrder.WorkOrderNumber}"
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };

        var dialog = await DialogService.ShowAsync<CMetalsWS.Components.Pages.Operations.WorkOrder.WorkOrderDialog>("Process Work Order", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
