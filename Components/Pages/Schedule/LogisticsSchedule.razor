@page "/schedule/logistics"

@inject WorkOrderService WorkOrderService
@inject BranchService BranchService
@inject AuthenticationStateProvider AuthStateProvider
@inject IHubContext<ScheduleHub> HubContext
@inject NavigationManager NavigationManager

@implements IAsyncDisposable

<MudPaper Class="pa-4">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h5">Logistics Schedule</MudText>

        <MudTabs>
            <MudTabPanel Text="Day">
                <MudCalendar T="CalendarItem" Items="_items" View="CalendarView.Day" />
            </MudTabPanel>
            <MudTabPanel Text="Week">
                <MudCalendar T="CalendarItem" Items="_items" View="CalendarView.Week" />
            </MudTabPanel>
            <MudTabPanel Text="Month">
                <MudCalendar T="CalendarItem" Items="_items" View="CalendarView.Month" />
            </MudTabPanel>
        </MudTabs>

        <MudDivider />

        <MudText Typo="Typo.h6">Unscheduled Logistics Orders</MudText>
        <MudList T="WorkOrder" Dense="true">
            @foreach (var wo in _unscheduled)
            {
                <MudListItem>
                    <MudListItemText>@wo.WorkOrderNumber - Tag: @wo.TagNumber - Due: @wo.DueDate:yyyy-MM-dd</MudListItemText>
                </MudListItem>
            }
        </MudList>
    </MudStack>
</MudPaper>

@code {
    private List<WorkOrder> _all = new();
    private List<WorkOrder> _unscheduled = new();
    private List<CalendarItem> _items = new();
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var branches = await BranchService.GetBranchesAsync();
        int? branchId = user.IsInRole("Admin") ? null : branches.FirstOrDefault()?.Id;

        await LoadOrders(branchId);
        BuildEvents();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/schedule"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<int>("WorkOrderUpdated", async (id) =>
        {
            await LoadOrders(branchId);
            BuildEvents();
            StateHasChanged();
        });

        await _hubConnection.StartAsync();
    }

    private async Task LoadOrders(int? branchId)
    {
        _all = (await WorkOrderService.GetAsync(branchId))
            .Where(w => (w.MachineCategory == MachineCategory.Sheet || w.MachineCategory == MachineCategory.Coil))
            .ToList();

        _unscheduled = _all.Where(w => w.ScheduledStartDate == null).ToList();
    }

    private void BuildEvents()
    {
        var scheduled = _all.Where(w => w.ScheduledStartDate != null).ToList();

        _items = scheduled.Select(w => new CalendarItem
        {
            Id = w.Id.ToString(),
            Text = w.WorkOrderNumber,
            Start = w.ScheduledStartDate!.Value,
            End = w.ScheduledEndDate ?? w.ScheduledStartDate!.Value.AddHours(1),
            AllDay = false
        }).ToList();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
            await _hubConnection.DisposeAsync();
    }
}
