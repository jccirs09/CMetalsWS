@using System.Linq
@using MudBlazor
@using Heron.MudCalendar
@using Microsoft.AspNetCore.SignalR.Client
@using CMetalsWS.Data
@using CMetalsWS.Services
@using CMetalsWS.Components.Pages.Operations.WorkOrder
@using MudBlazor.Utilities
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization

@inject WorkOrderService WorkOrderService
@inject MachineService MachineService
@inject BranchService BranchService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@implements IAsyncDisposable

<MudPaper Class="d-flex flex-grow-1 pa-4" Elevation="0">
    <MudCalendar T="ScheduleEvent" Items="_events"
                 EnableDragItems="true"
                 EnableResizeItems="true"
                 MonthCellMinHeight="120"
                 ItemClicked="OnItemClicked"
                 ItemChanged="OnItemChanged"
                 DayStartTime="_branchWorkHours.Start"
                 DayEndTime="_branchWorkHours.End"
                 DayTimeInterval="CalendarTimeInterval.Minutes15"
                 FirstDayOfWeek="_firstDayOfWeek"
                 Height="1080"
                 CalendarView="CalendarView.Week">
        <ToolbarContent>
            <MudText Typo="Typo.h5">@Title</MudText>
            <MudSpacer />
            <MudSelect T="int" Label="Machine" Value="_selectedMachineId" ValueChanged="OnSelectedMachineChanged" Dense="true" Margin="Margin.Dense" Style="min-width:240px">
                @foreach (var m in _machines)
                {
                    <MudSelectItem T="int" Value="@m.Id">@m.Name</MudSelectItem>
                }
            </MudSelect>
        </ToolbarContent>
    </MudCalendar>
</MudPaper>

@code {
    private class ScheduleEvent : CalendarItem
    {
        public WorkOrder WorkOrder { get; init; } = default!;
        public Color Color { get; set; }
    }

    [Parameter]
    public string Title { get; set; } = string.Empty;

    [Parameter]
    public MachineCategory MachineCategory { get; set; }

    [Parameter]
    public Color Color { get; set; } = Color.Primary;

    private List<Machine> _machines = new();
    private List<ScheduleEvent> _events = new();
    private int _selectedMachineId;
    private HubConnection? _hub;
    private (TimeOnly Start, TimeOnly End) _branchWorkHours;
    private DayOfWeek _firstDayOfWeek = DayOfWeek.Monday;
    private int? _currentBranchId;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(auth.User);
        _currentBranchId = user?.BranchId;

        var branches = await BranchService.GetBranchesAsync();
        var branch = branches.FirstOrDefault(b => b.Id == _currentBranchId);
        _branchWorkHours = branch is not null && branch.StartTime.HasValue && branch.EndTime.HasValue
            ? (branch.StartTime.Value, branch.EndTime.Value)
            : (new(5, 0, 0), new(23, 0, 0));

        _machines = (await MachineService.GetMachinesAsync())
            .Where(m => m.Category == MachineCategory && (!_currentBranchId.HasValue || m.BranchId == _currentBranchId.Value))
            .ToList();
        if (_machines.Any()) _selectedMachineId = _machines.First().Id;

        await LoadWorkOrders(_currentBranchId);
        await SetupSignalRAsync(_currentBranchId);
    }

    private async Task LoadWorkOrders(int? branchId)
    {
        var workOrders = (await WorkOrderService.GetByCategoryAsync(MachineCategory, branchId))
            .Where(w => _selectedMachineId == 0 || w.MachineId == _selectedMachineId)
            .ToList();

        _events = workOrders.Select(wo => new ScheduleEvent
        {
            WorkOrder = wo,
            Start = wo.ScheduledStartDate,
            End = wo.ScheduledEndDate,
            Text = wo.WorkOrderNumber,
            Color = this.Color
        }).ToList();
    }

    private async Task SetupSignalRAsync(int? branchId)
    {
        _hub = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/schedule"))
            .WithAutomaticReconnect()
            .Build();

        _hub.On<int>("WorkOrderUpdated", async (id) =>
        {
            await InvokeAsync(async () =>
            {
                await LoadWorkOrders(branchId);
                StateHasChanged();
            });
        });

        try
        {
            await _hub.StartAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"SignalR connection failed: {ex.Message}", Severity.Warning);
        }
    }

    private async Task OnItemClicked(CalendarItem item)
    {
        if (item is not ScheduleEvent scheduleEvent) return;

        var detailsParams = new DialogParameters { ["WorkOrderId"] = scheduleEvent.WorkOrder.Id };
        var detailsDialog = await DialogService.ShowAsync<Dialogs.WorkOrderDetailsDialog>("Work Order Details", detailsParams);
        var detailsResult = await detailsDialog.Result;
        if (detailsResult is null || detailsResult.Canceled) return;

        if (detailsResult.Data is string action && (action == "edit" || action == "process"))
        {
            await ShowWorkOrderDialogAsync(scheduleEvent.WorkOrder, action);
        }
    }

    private async Task ShowWorkOrderDialogAsync(WorkOrder wo, string mode)
    {
        var isProcessing = string.Equals(mode, "process", StringComparison.OrdinalIgnoreCase);

        // Clone to avoid side-effects from two-way binding before save
        var clone = new WorkOrder
        {
            Id = wo.Id,
            WorkOrderNumber = wo.WorkOrderNumber,
            TagNumber = wo.TagNumber,
            BranchId = wo.BranchId,
            MachineId = wo.MachineId,
            MachineCategory = wo.MachineCategory,
            DueDate = wo.DueDate,
            Instructions = wo.Instructions,
            Status = wo.Status,
            ScheduledStartDate = wo.ScheduledStartDate,
            ScheduledEndDate = wo.ScheduledEndDate,
            Items = wo.Items.Select(i => new WorkOrderItem
            {
                Id = i.Id,
                WorkOrderId = wo.Id,
                PickingListItemId = i.PickingListItemId,
                ItemCode = i.ItemCode,
                Description = i.Description,
                SalesOrderNumber = i.SalesOrderNumber,
                CustomerName = i.CustomerName,
                OrderQuantity = i.OrderQuantity,
                OrderWeight = i.OrderWeight,
                Width = i.Width,
                Length = i.Length,
                ProducedQuantity = i.ProducedQuantity,
                ProducedWeight = i.ProducedWeight,
                Unit = i.Unit,
                Location = i.Location
            }).ToList()
        };

        var parameters = new DialogParameters
        {
            ["Model"] = clone,
            ["Machines"] = _machines,
            ["Branches"] = await BranchService.GetBranchesAsync(),
            ["Title"] = isProcessing ? $"Process {wo.WorkOrderNumber}" : $"Edit {wo.WorkOrderNumber}",
            ["IsEdit"] = true,
            ["IsProcessing"] = isProcessing
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.ExtraLarge, FullWidth = true, BackdropClick = false };
        var dialog = await DialogService.ShowAsync<WorkOrderDialog>(isProcessing ? "Process Work Order" : "Edit Work Order", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            if (result.Data is WorkOrder updated)
            {
                try
                {
                    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
                    var user = auth.User;
                    var updatedBy = user?.Identity?.Name ?? "system";
                    await WorkOrderService.UpdateAsync(updated, updatedBy);
                    Snackbar.Add("Work order updated.", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to update: {ex.Message}", Severity.Error);
                }
            }

            await ReloadDataAndRefresh();
        }
    }

    private async Task OnItemChanged(CalendarItem item)
    {
        if (item is not ScheduleEvent scheduleEvent) return;

        try
        {
            await WorkOrderService.ScheduleAsync(scheduleEvent.WorkOrder.Id, item.Start, item.End);
            Snackbar.Add("Work Order updated successfully!", Severity.Success);
            await ReloadDataAndRefresh();
            if (_hub is not null)
                await _hub.SendAsync("WorkOrderUpdated", scheduleEvent.WorkOrder.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating Work Order: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadDataAndRefresh()
    {
        await LoadWorkOrders(_currentBranchId);
        StateHasChanged();
    }

    private async Task OnSelectedMachineChanged(int value)
    {
        _selectedMachineId = value;
        await LoadWorkOrders(_currentBranchId);
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hub is not null)
        {
            try { await _hub.DisposeAsync(); }
            catch { /* ignored */ }
        }
    }
}
