@page "/messages"
@page "/messages/{ThreadId}"
@using System.Security.Claims
@using CMetalsWS.Data.Chat
@using CMetalsWS.Services
@inject ChatStateService ChatState
@inject NavigationManager Nav
@implements IDisposable

<MudGrid Class="h-100 pa-3" Style="min-height:calc(100vh - 128px)">
  <MudItem xs="12" md="4" lg="3">
    <ChatThreadList OnThreadSelected="OpenThread" />
  </MudItem>

  <MudItem xs="12" md="8" lg="9">
    @if (!string.IsNullOrWhiteSpace(ChatState.ActiveThreadId))
    {
      <ChatConversation
          @key="ChatState.ActiveThreadId"
          ThreadId="@ChatState.ActiveThreadId" />
    }
    else
    {
      <MudPaper Class="d-flex align-center justify-center" Style="height:70vh;">
        <MudText Typo="Typo.h6" Class="mud-text-secondary">
          Select a conversation to start chatting
        </MudText>
      </MudPaper>
    }
  </MudItem>
</MudGrid>

@code {
  [Parameter] public string? ThreadId { get; set; }

  protected override void OnInitialized()
  {
    ChatState.OnChange += StateHasChanged;
  }

  [Inject] private IChatRepository ChatRepository { get; set; } = default!;
  [Inject] private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

  protected override async Task OnParametersSetAsync()
  {
    if (!string.IsNullOrWhiteSpace(ThreadId))
    {
      ChatState.ActivateThread(ThreadId);
    }
    else
    {
      var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var userId = authState.User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier);
      if (userId != null)
      {
        var summaries = await ChatRepository.GetThreadSummariesAsync(userId);
        var latestThread = summaries.OrderByDescending(s => s.LastActivityAt).FirstOrDefault();
        if (latestThread?.Id != null)
        {
          Nav.NavigateTo($"/messages/{latestThread.Id}", replace: true);
        }
      }
    }
  }

  private void OpenThread(ThreadSummary t) => ChatState.HandleThreadClick(t);

  public void Dispose() => ChatState.OnChange -= StateHasChanged;
}
