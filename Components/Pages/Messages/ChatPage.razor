@page "/messages"
@page "/messages/{ThreadId}"
@using CMetalsWS.Data.Chat
@using CMetalsWS.Services
@using CMetalsWS.Components.Shared.Chat
@inject ChatStateService ChatState
@inject NavigationManager Nav
@inject IDialogService DialogService
@implements IDisposable

<MudPaper Elevation="0" Class="d-flex" Style="height: 100%;">
    <div class="d-flex flex-column pa-4" style="width: 350px; border-right: 1px solid var(--mud-palette-lines-default);">
        <MessagingHeader OnSearch="HandleSearch" OnNewChatClicked="HandleNewChat" />
        <div class="flex-grow-1 mt-3" style="overflow-y: auto;">
            <MessagingSystem OnThreadSelected="OpenThread" SearchQuery="@_searchQuery" />
        </div>
    </div>

    <div class="flex-grow-1 d-flex flex-column">
        @if (!string.IsNullOrWhiteSpace(ChatState.ActiveThreadId))
        {
            <ChatConversation @key="ChatState.ActiveThreadId"
                              ThreadId="@ChatState.ActiveThreadId" />
        }
        else
        {
            <div class="d-flex align-center justify-center flex-grow-1">
                <div class="d-flex flex-column align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Large" Class="mb-4" Color="Color.Inherit" />
                    <MudText Typo="Typo.h6" Class="mud-text-secondary">Welcome to Messages</MudText>
                    <MudText Class="mud-text-secondary">Select a conversation from the sidebar to start messaging.</MudText>
                </div>
            </div>
        }
    </div>
</MudPaper>

@code {
    [Parameter] public string? ThreadId { get; set; }

    private string _searchQuery = string.Empty;

    protected override void OnInitialized()
    {
        ChatState.OnChange += StateHasChanged;
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(ThreadId) && ThreadId != ChatState.ActiveThreadId)
        {
            ChatState.ActivateThread(ThreadId);
        }
    }

    private void OpenThread(ThreadSummary t)
    {
        Nav.NavigateTo($"/messages/{t.Id}");
    }

    private void HandleSearch(string query)
    {
        _searchQuery = query;
        StateHasChanged();
    }

    private async Task HandleNewChat()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<NewChatDialog>("New Chat", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string userId)
        {
            Nav.NavigateTo($"/messages/{userId}");
        }
    }

    public void Dispose()
    {
        ChatState.OnChange -= StateHasChanged;
    }
}