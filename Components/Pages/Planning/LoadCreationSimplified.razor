@using System.Security.Claims
@using CMetalsWS.Data
@using CMetalsWS.Models
@using CMetalsWS.Services
@using MudBlazor
@inject LoadService LoadService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudGrid Spacing="4">
    @* Ship Dates Column *@
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Style="height: 100%;">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">Ship Dates</MudText>
                <div class="text-right">
                    <MudText Typo="Typo.body2"><b>@FilteredAvailableOrders.Sum(o => o.Weight).ToString("N0") lbs</b></MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">@FilteredAvailableOrders.Count() orders total</MudText>
                </div>
            </div>
            <MudList T="DateTime?" Clickable="true" SelectedValue="SelectedShipDate" SelectedValueChanged="OnSelectedShipDateChanged" Style="max-height: 70vh; overflow-y: auto;">
                @foreach (var date in AvailableShipDates)
                {
                    <MudListItem Value="@((DateTime?)date)">
                        <div class="d-flex justify-space-between align-center" style="width:100%">
                            <div>
                                <MudText><b>@date.ToString("dddd, MMM dd")</b></MudText>
                                <MudText Typo="Typo.caption" Class="text-muted">@date.ToString("yyyy")</MudText>
                            </div>
                            <div class="text-right">
                                <MudText Typo="Typo.body2"><b>@OrdersByDate(date).Sum(o => o.Weight).ToString("N0") lbs</b></MudText>
                                <MudText Typo="Typo.caption" Class="text-muted">@OrdersByDate(date).Count() orders</MudText>
                            </div>
                        </div>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

    @* Orders & Line Items Column *@
    <MudItem xs="12" md="5">
        <MudPaper Class="pa-4" Style="height: 100%;">
            <div class="d-flex justify-space-between align-center mb-4">
                <div>
                    <MudText Typo="Typo.h6">Orders & Line Items</MudText>
                    <MudText Typo="Typo.body2" Class="text-muted">@OrdersForSelectedDate.Count() Available Orders</MudText>
                </div>
                <MudButton Variant="Variant.Text" @onclick="ClearSelections">Clear Selections</MudButton>
            </div>

            <div class="d-flex flex-column gap-4" style="max-height: 70vh; overflow-y: auto;">
                @foreach (var order in OrdersForSelectedDate)
                {
                    <MudPaper Outlined="true">
                        <MudExpansionPanel Text="@($"{order.CustomerName} ({order.OrderNumber})")">
                            <TitleContent>
                                <div class="d-flex align-center pa-1" style="width:100%">
                                    <MudCheckBox T="bool" Value="@(SelectedOrders.Contains(order))" ValueChanged="@((bool val) => ToggleOrderSelection(order, val))" Class="mr-2" />
                                    <div class="flex-grow-1">
                                        <MudText><b>@order.CustomerName</b></MudText>
                                        <MudText Typo="Typo.body2" Class="text-muted">@order.OrderNumber</MudText>
                                    </div>
                                    <div class="text-right">
                                        <MudText>@order.Weight.ToString("N0") lbs</MudText>
                                        <MudText Typo="Typo.body2" Class="text-muted">@order.Pieces pcs</MudText>
                                    </div>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudTable Items="@order.Items" Dense="true" Hover="true" Class="mt-2">
                                    <HeaderContent>
                                        <MudTh></MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh>Quantity</MudTh>
                                        <MudTh>Weight</MudTh>
                                        <MudTh>Status</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd><MudCheckBox T="bool" Value="@IsItemSelected(context)" ValueChanged="@((bool val) => ToggleItemSelection(order, context, val))" /></MudTd>
                                        <MudTd DataLabel="Description">@context.Description</MudTd>
                                        <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
                                        <MudTd DataLabel="Weight">@context.Weight.ToString("N0") lbs</MudTd>
                                        <MudTd DataLabel="Status"><MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Status)">@context.Status</MudChip></MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudPaper>
                }
            </div>
        </MudPaper>
    </MudItem>

    @* Create Load Column *@
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Style="height: 100%;">
            <MudText Typo="Typo.h6" GutterBottom="true">Create Load</MudText>

            <MudCard Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.subtitle1"><b>Line Items:</b> @SelectedItems.Count</MudText>
                    <MudText Typo="Typo.subtitle1"><b>Orders:</b> @SelectedOrders.Count</MudText>
                    <MudText Typo="Typo.h5" Class="mt-2"><b>@TotalSelectedWeight.ToString("N0") lbs</b></MudText>
                </MudCardContent>
            </MudCard>

            <MudForm>
                <MudDatePicker Label="Scheduled Ship Date" @bind-Date="ScheduledShipDate" Class="mb-4" />
                <MudTextField @bind-Value="LoadNotes" Label="Load Notes (Optional)" T="string" Lines="3" Class="mb-4" />

                <MudText Typo="Typo.h6" Class="mb-2">Select Truck</MudText>
                <MudRadioGroup @bind-SelectedOption="SelectedTruckId" T="string">
                    @foreach (var truck in AvailableTrucks)
                    {
                        <MudCard Outlined="true" Class="mb-2 pa-2">
                            <div class="d-flex align-center">
                                <div class="flex-grow-1">
                                    <MudText><b>@truck.Name</b> @(truck.IsRecommended ? "(Recommended)" : "")</MudText>
                                    <MudText Typo="Typo.body2">@truck.Type - @truck.Driver</MudText>
                                    <MudProgressLinear Value="@((GetProjectedLoad(truck) / (double)truck.Capacity) * 100)" Color="@GetProjectedLoadColor(truck)" Class="my-1" />
                                    <MudText Typo="Typo.caption">@GetProjectedLoad(truck).ToString("N0") / @truck.Capacity.ToString("N0") lbs</MudText>
                                </div>
                                <MudRadio T="string" Value="@truck.Id" />
                            </div>
                        </MudCard>
                    }
                </MudRadioGroup>
            </MudForm>

            <div class="mt-auto">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4" Disabled="@(SelectedItems.Count == 0)" OnClick="CreateLoadAsync">Create Load</MudButton>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public List<AvailableOrder> AllAvailableOrders { get; set; } = new();
    [Parameter] public List<TruckInfo> AvailableTrucks { get; set; } = new();
    [Parameter] public EventCallback OnLoadCreated { get; set; }
    [Parameter] public string? SelectedRegionName { get; set; }

    private DateTime? SelectedShipDate { get; set; }
    private DateTime? ScheduledShipDate { get; set; }
    private string LoadNotes { get; set; }
    private string SelectedTruckId { get; set; }

    private HashSet<AvailableOrder> SelectedOrders { get; set; } = new();
    private HashSet<OrderItem> SelectedItems { get; set; } = new();

    private List<AvailableOrder> FilteredAvailableOrders => string.IsNullOrEmpty(SelectedRegionName)
        ? AllAvailableOrders
        : AllAvailableOrders.Where(o => o.DeliveryRegion == SelectedRegionName).ToList();

    private List<DateTime> AvailableShipDates => FilteredAvailableOrders
        .Select(o => o.ReadyDate.Date)
        .Distinct()
        .OrderBy(d => d)
        .ToList();

    private IEnumerable<AvailableOrder> OrdersByDate(DateTime date) => FilteredAvailableOrders
        .Where(o => o.ReadyDate.Date == date.Date);

    private IEnumerable<AvailableOrder> OrdersForSelectedDate => SelectedShipDate.HasValue
        ? OrdersByDate(SelectedShipDate.Value)
        : Enumerable.Empty<AvailableOrder>();

    private int TotalSelectedWeight => SelectedItems.Sum(i => i.Weight);

    private void OnSelectedShipDateChanged(DateTime? newDate)
    {
        SelectedShipDate = newDate;
        ClearSelections();
        StateHasChanged();
    }

    private void ClearSelections()
    {
        SelectedOrders.Clear();
        SelectedItems.Clear();
        StateHasChanged();
    }

    private void ToggleOrderSelection(AvailableOrder order, bool isSelected)
    {
        if (isSelected)
        {
            SelectedOrders.Add(order);
            foreach (var item in order.Items)
            {
                SelectedItems.Add(item);
            }
        }
        else
        {
            SelectedOrders.Remove(order);
            foreach (var item in order.Items)
            {
                SelectedItems.Remove(item);
            }
        }
        StateHasChanged();
    }

    private void ToggleItemSelection(AvailableOrder order, OrderItem item, bool isSelected)
    {
        if (isSelected)
        {
            SelectedItems.Add(item);
        }
        else
        {
            SelectedItems.Remove(item);
        }

        if (order.Items.All(i => SelectedItems.Contains(i)))
        {
            SelectedOrders.Add(order);
        }
        else
        {
            SelectedOrders.Remove(order);
        }
        StateHasChanged();
    }

    private bool IsItemSelected(OrderItem item) => SelectedItems.Contains(item);

    private Color GetStatusColor(string status) => status switch
    {
        "picked" => Color.Info,
        "packed" => Color.Success,
        "ready" => Color.Primary,
        _ => Color.Default
    };

    private int GetProjectedLoad(TruckInfo truck) => truck.CurrentLoad + TotalSelectedWeight;

    private Color GetProjectedLoadColor(TruckInfo truck)
    {
        if (truck.Capacity == 0) return Color.Primary;
        var projectedLoad = GetProjectedLoad(truck);
        var percentage = (double)projectedLoad / truck.Capacity;
        if (percentage > 1) return Color.Error;
        if (percentage > 0.9) return Color.Warning;
        return Color.Primary;
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(SelectedRegionName) || (AvailableShipDates.Any() && SelectedShipDate == null))
        {
            SelectedShipDate = AvailableShipDates.FirstOrDefault();
        }
    }

    private async Task CreateLoadAsync()
    {
        if (SelectedItems.Count == 0 || string.IsNullOrEmpty(SelectedTruckId))
        {
            Snackbar.Add("Please select items and a truck for the load.", Severity.Warning);
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        var selectedTruck = AvailableTrucks.FirstOrDefault(t => t.Id == SelectedTruckId);

        if (selectedTruck == null)
        {
            Snackbar.Add("Selected truck not found.", Severity.Error);
            return;
        }

        var newLoad = new Load
        {
            TruckId = int.Parse(SelectedTruckId),
            ShippingDate = ScheduledShipDate,
            Status = LoadStatus.Pending,
            Notes = LoadNotes,
            OriginBranchId = selectedTruck.BranchId,
            TotalWeight = SelectedItems.Sum(i => i.Weight)
        };

        var loadItems = new List<Data.LoadItem>();
        var ordersWithSelectedItems = AllAvailableOrders.Where(o => o.Items.Any(i => SelectedItems.Contains(i)));

        foreach (var order in ordersWithSelectedItems)
        {
            var itemsToLoad = order.Items.Where(i => SelectedItems.Contains(i));
            foreach (var item in itemsToLoad)
            {
                loadItems.Add(new Data.LoadItem
                {
                    PickingListId = int.Parse(order.Id),
                    PickingListItemId = int.Parse(item.Id),
                    ShippedWeight = item.Weight,
                    ShippedQuantity = item.Quantity
                });
            }
        }

        newLoad.Items = loadItems;

        if (!newLoad.Items.Any())
        {
            Snackbar.Add("Could not find selected items to create the load. Please try again.", Severity.Error);
            return;
        }

        try
        {
            await LoadService.CreateAsync(newLoad, userId);
            Snackbar.Add("Load created successfully!", Severity.Success);
            ClearSelections();
            await OnLoadCreated.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating load: {ex.Message}", Severity.Error);
        }
    }
}