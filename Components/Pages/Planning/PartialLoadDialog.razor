@using CMetalsWS.Data
@using MudBlazor
@using System.ComponentModel.DataAnnotations

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Partial Load Selection</MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@_formModel" OnValidSubmit="Submit">
            <DataAnnotationsValidator />
            <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                <thead>
                    <tr>
                        <th></th>
                        <th>Stock #</th>
                        <th>Description</th>
                        <th style="text-align:right">Remaining Qty</th>
                        <th style="text-align:right">Remaining Wt.</th>
                        <th style="text-align:right">Ship Qty</th>
                        <th style="text-align:right">Ship Wt.</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in _itemsToDisplay)
                    {
                        <tr @key="row.Id">
                            <td>
                                <MudCheckBox T="bool" Value="@row.IsSelected" ValueChanged="@((bool val) => OnItemChecked(val, row))" />
                            </td>
                            <td>@row.Item.ItemId</td>
                            <td>@row.Item.ItemDescription</td>
                            <td style="text-align:right">@row.Item.RemainingQuantity.ToString("N2")</td>
                            <td style="text-align:right">@row.Item.RemainingWeight.ToString("N2")</td>
                            <td>
                                <MudNumericField T="decimal"
                                                 Value="row.ShipQuantity"
                                                 ValueChanged="@((decimal val) => { row.ShipQuantity = val; OnShipQuantityChanged(row); })"
                                                 Disabled="@(!row.IsSelected)"
                                                 Margin="Margin.Dense"
                                                 Validation="@((decimal q) => ValidateQuantity(q, row))" />
                            </td>
                            <td>
                                <MudNumericField T="decimal"
                                                 Value="row.ShipWeight"
                                                 ValueChanged="@((decimal val) => { row.ShipWeight = val; })"
                                                 Disabled="@(!row.IsSelected)"
                                                 Margin="Margin.Dense"
                                                 Validation="@((decimal w) => ValidateWeight(w, row))" />
                            </td>
                            <td>
                                <MudIconButton Icon="@Icons.Material.Filled.Splitscreen" Size="Size.Small" OnClick="@(() => SplitRow(row))" />
                                @if(row.IsSplit)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Size="Size.Small" OnClick="@(() => RemoveSplitRow(row))" />
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_itemsToDisplay.Any(i => i.IsSelected))">Add to Load</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<PickingListItem> PickingListItems { get; set; } = new();

    private List<DialogRow> _itemsToDisplay = new();
    private object _formModel = new(); // Dummy model for EditForm

    public class PartialShipmentItem
    {
        public int PickingListItemId { get; set; }
        public decimal Quantity { get; set; }
        public decimal Weight { get; set; }
    }

    private class DialogRow
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public required PickingListItem Item { get; set; }
        public decimal ShipQuantity { get; set; }
        public decimal ShipWeight { get; set; }
        public bool IsSelected { get; set; }
        public bool IsSplit { get; set; } = false;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _itemsToDisplay = PickingListItems.Select(i => new DialogRow
        {
            Item = i,
            ShipQuantity = 0,
            ShipWeight = 0,
            IsSelected = false
        }).ToList();
    }

    private void OnItemChecked(bool isChecked, DialogRow row)
    {
        row.IsSelected = isChecked;
        if (isChecked)
        {
            // Default to full remaining quantity/weight only if it's the only one for this item.
            var otherRows = _itemsToDisplay.Where(r => r.Item.Id == row.Item.Id && r.Id != row.Id).ToList();
            if (!otherRows.Any(r => r.IsSelected))
            {
                row.ShipQuantity = row.Item.RemainingQuantity - otherRows.Sum(r => r.ShipQuantity);
                row.ShipWeight = row.Item.RemainingWeight - otherRows.Sum(r => r.ShipWeight);
            }
        }
        else
        {
            row.ShipQuantity = 0;
            row.ShipWeight = 0;
        }
        StateHasChanged();
    }

    private void OnShipQuantityChanged(DialogRow row)
    {
        if (row.Item.RemainingWeight > 0 && row.Item.RemainingQuantity > 0)
        {
            row.ShipWeight = (row.ShipQuantity / row.Item.RemainingQuantity) * row.Item.RemainingWeight;
        }
        StateHasChanged();
    }

    private void SplitRow(DialogRow originalRow)
    {
        var newRow = new DialogRow
        {
            Item = originalRow.Item,
            ShipQuantity = 0,
            ShipWeight = 0,
            IsSelected = true, // New split rows are selected by default.
            IsSplit = true
        };
        var index = _itemsToDisplay.IndexOf(originalRow);
        _itemsToDisplay.Insert(index + 1, newRow);

        originalRow.IsSplit = true; // Mark the original row as split as well.

        StateHasChanged();
    }

    private void RemoveSplitRow(DialogRow rowToRemove)
    {
        _itemsToDisplay.Remove(rowToRemove);

        // If only one row remains for this item, it's no longer considered a "split"
        if (_itemsToDisplay.Count(r => r.Item.Id == rowToRemove.Item.Id) == 1)
        {
            _itemsToDisplay.First(r => r.Item.Id == rowToRemove.Item.Id).IsSplit = false;
        }

        StateHasChanged();
    }

    private IEnumerable<string> ValidateQuantity(decimal quantity, DialogRow row)
    {
        if (quantity < 0)
        {
            yield return "Quantity cannot be negative.";
        }

        var totalQuantityForThisItem = _itemsToDisplay
            .Where(r => r.Item.Id == row.Item.Id)
            .Sum(r => r.ShipQuantity);

        if (totalQuantityForThisItem > row.Item.RemainingQuantity)
        {
            yield return "Total ship quantity exceeds available quantity.";
        }
    }

    private IEnumerable<string> ValidateWeight(decimal weight, DialogRow row)
    {
        if (weight < 0)
        {
            yield return "Weight cannot be negative.";
        }

        var totalWeightForThisItem = _itemsToDisplay
            .Where(r => r.Item.Id == row.Item.Id)
            .Sum(r => r.ShipWeight);

        if (totalWeightForThisItem > row.Item.RemainingWeight)
        {
            yield return "Total ship weight exceeds available weight.";
        }
    }

    private void Submit()
    {
        var result = _itemsToDisplay
            .Where(i => i.IsSelected && (i.ShipQuantity > 0 || i.ShipWeight > 0))
            .Select(i => new PartialShipmentItem
            {
                PickingListItemId = i.Item.Id,
                Quantity = i.ShipQuantity,
                Weight = i.ShipWeight
            })
            .ToList();

        MudDialog.Close(DialogResult.Ok(result));
    }
    private void Cancel() => MudDialog.Cancel();
}