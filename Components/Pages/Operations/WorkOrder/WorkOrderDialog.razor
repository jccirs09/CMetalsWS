@using CMetalsWS.Data
@using CMetalsWS.Services
@using MudBlazor
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject InventoryService InvService
@inject ItemRelationshipService RelService
@inject PickingListService PlService

<MudDialog Title="@Title">
    <DialogContent>
        <MudForm @ref="_form">
            <MudStack Spacing="3">
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="int?" Label="Machine" @bind-Value="MachineId" Required="true" Margin="Margin.Dense">
                            @foreach (var m in Machines)
                            {
                                <MudSelectItem T="int?" Value="m.Id">@m.Name (@m.Category)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="MachineCategory" Label="Category" @bind-Value="Model.MachineCategory" Disabled="true" Margin="Margin.Dense">
                            @foreach (var cat in Enum.GetValues<MachineCategory>())
                            {
                                <MudSelectItem Value="cat">@cat</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudDatePicker Label="Due Date" @bind-Date="DueDateValue" Required="true" Margin="Margin.Dense"/>
                    </MudItem>
                </MudGrid>

                <MudStack Row="true" AlignItems="AlignItems.End">
                    <MudTextField T="string" Label="Tag Number" @bind-Value="Model.TagNumber" Required="true" />
                    <MudButton Variant="Variant.Outlined" OnClick="SearchByTag" IsEnabled="@(!IsEdit)">Search by Tag</MudButton>
                </MudStack>
                @if (!string.IsNullOrWhiteSpace(_parentCoilDescription))
                {
                    <MudText>Parent Coil: <b>@_parentCoilDescription</b></MudText>
                }

                @if (_childItemPreview.Any())
                {
                    <MudText Typo="Typo.h6">Child Items</MudText>
                    <MudSimpleTable Dense="true" Bordered="true">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Description</th>
                                <th>Width</th>
                                <th>Length</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _childItemPreview)
                            {
                                <tr>
                                    <td>@item.ItemId</td>
                                    <td>@item.Description</td>
                                    <td>@item.Width</td>
                                    <td>@item.Length</td>
                                    <td><MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => AddChildItemToWorkOrder(item))">Add</MudButton></td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }

                <MudTextField T="string" Label="Instructions" @bind-Value="Model.Instructions" Lines="3" />

                <MudDivider />
                <MudText Typo="Typo.h6">Line Items</MudText>

                <MudTable Items="Model.Items" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Item</MudTh>
                        <MudTh>SO #</MudTh>
                        <MudTh>Customer</MudTh>
                        <MudTh>Order Qty or Wt</MudTh>
                        <MudTh>Width</MudTh>
                        @if (Model.MachineCategory == MachineCategory.CTL)
                        {
                            <MudTh>Length</MudTh>
                        }
                        <MudTh>Weight</MudTh>
                        <MudTh>Produced Qty or Wt</MudTh>
                        <MudTh>Location</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd><MudTextField T="string" @bind-Value="context.ItemCode" /></MudTd>
                        <MudTd><MudTextField T="string" @bind-Value="context.SalesOrderNumber" /></MudTd>
                        <MudTd><MudTextField T="string" @bind-Value="context.CustomerName" /></MudTd>
                        <MudTd>
                            @if (Model.MachineCategory == MachineCategory.CTL)
                            {
                                <MudTextField T="decimal?" @bind-Value="context.OrderQuantity" />
                            }
                            else
                            {
                                <MudTextField T="decimal?" @bind-Value="context.OrderWeight" />
                            }
                        </MudTd>
                        <MudTd><MudTextField T="decimal?" @bind-Value="context.Width" /></MudTd>
                        @if (Model.MachineCategory == MachineCategory.CTL)
                        {
                            <MudTd><MudTextField T="decimal?" @bind-Value="context.Length" /></MudTd>
                        }
                        <MudTd><MudTextField T="decimal?" @bind-Value="context.Weight" /></MudTd>
                        <MudTd>
                            @if (Model.MachineCategory == MachineCategory.CTL)
                            {
                                <MudTextField T="decimal?" @bind-Value="context.ProducedQuantity" />
                            }
                            else
                            {
                                <MudTextField T="decimal?" @bind-Value="context.ProducedWeight" />
                            }
                        </MudTd>
                        <MudTd><MudTextField T="string" @bind-Value="context.Location" /></MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveLine(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                    <MudButton Variant="Variant.Text" OnClick="AddStockLine">Add Stock Line</MudButton>
                    <MudButton Variant="Variant.Text" OnClick="AddReturnLine">Add Return Line</MudButton>
                </MudStack>
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public WorkOrder Model { get; set; } = new();
    [Parameter] public List<Machine> Machines { get; set; } = new();
    [Parameter] public List<Branch> Branches { get; set; } = new();
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public bool IsEdit { get; set; }

    private MudForm? _form;
    private string? _parentCoilDescription;
    private List<InventoryItem> _childItemPreview = new();

    private int? MachineId
    {
        get => Model.MachineId;
        set
        {
            Model.MachineId = value;
            SyncCategoryWithMachine();
        }
    }

    private DateTime? DueDateValue
    {
        get => Model.DueDate;
        set => Model.DueDate = value ?? Model.DueDate;
    }

    protected override void OnParametersSet()
    {
        SyncCategoryWithMachine();
    }

    private void SyncCategoryWithMachine()
    {
        var machine = Machines.FirstOrDefault(m => m.Id == Model.MachineId);
        if (machine != null)
            Model.MachineCategory = machine.Category;
    }

    private async Task AddChildItemToWorkOrder(InventoryItem item)
    {
        // Create the new WorkOrderItem
        var newItem = new WorkOrderItem
        {
            ItemCode = item.ItemId,
            Description = item.Description, // This will be removed from the table display, but good to have in the model
            Width = item.Width,
            Length = item.Length,
            Weight = item.Snapshot
        };

        // Ask user to select a pending picking list for this specific item
        var parameters = new DialogParameters
        {
            ["RequiredItemIds"] = new List<string> { item.ItemId }
        };
        var dialog = await DialogService.ShowAsync<SelectPickingListDialog>("Select Picking List Item", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<PickingListItem> selectedPlItems && selectedPlItems.Any())
        {
            // For now, assume the user selects one PL item for the WO item
            var plItem = selectedPlItems.First();
            newItem.PickingListItemId = plItem.Id;
            newItem.SalesOrderNumber = plItem.PickingList.SalesOrderNumber;
            newItem.CustomerName = plItem.PickingList.CustomerName;
            newItem.OrderQuantity = plItem.Quantity;
            newItem.OrderWeight = plItem.Weight;

            Model.Items.Add(newItem);
            _childItemPreview.Remove(item); // Remove from preview
            StateHasChanged();
            Snackbar.Add($"Added item {item.ItemId} from SO {plItem.PickingList.SalesOrderNumber}", Severity.Success);
        }
        else
        {
            // Optional: Handle case where user cancels or doesn't select a picking list item.
            // For now, we just won't add the item to the work order.
            Snackbar.Add("No picking list item selected. Item not added to work order.", Severity.Info);
        }
    }

    private async Task SearchByTag()
    {
        _parentCoilDescription = null;
        _childItemPreview.Clear();

        if (string.IsNullOrWhiteSpace(Model.TagNumber))
        {
            Snackbar.Add("Please enter a Tag Number.", Severity.Warning);
            return;
        }

        try
        {
            var parent = await InvService.GetByTagNumberAsync(Model.TagNumber);
            if (parent is null)
            {
                Snackbar.Add($"Tag '{Model.TagNumber}' not found.", Severity.Error);
                return;
            }

            var (parentDesc, children) = await RelService.GetAsync(parent.ItemId);
            if (children.Count == 0)
            {
                Snackbar.Add($"No child items (sheets) are related to the coil with tag '{Model.TagNumber}'. Use the 'Item Relationships' page to add some.", Severity.Info);
                return;
            }

            var childItemIds = children.Select(c => c.childId).ToList();
            var childInventoryItems = await InvService.GetByItemIdsAsync(childItemIds);

            _parentCoilDescription = parentDesc;
            _childItemPreview = childInventoryItems;

            Snackbar.Add($"Found {_childItemPreview.Count} child item(s) for Tag '{Model.TagNumber}'.", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        if (_form is not null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        MudDialog.Close(DialogResult.Ok(Model));
    }

    private void AddStockLine()
    {
        Model.Items.Add(new WorkOrderItem
        {
            ItemCode = string.Empty,
            Description = string.Empty
        });
    }

    private void AddReturnLine()
    {
        Model.Items.Add(new WorkOrderItem
        {
            ItemCode = "RETURN",
            Description = "Return to stock",
            OrderQuantity = 0,
            OrderWeight = 0,
            ProducedQuantity = 0,
            ProducedWeight = 0
        });
    }

    private void RemoveLine(WorkOrderItem item)
    {
        Model.Items.Remove(item);
    }
}
