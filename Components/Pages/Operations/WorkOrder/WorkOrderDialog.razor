@using CMetalsWS.Data
@using CMetalsWS.Services
@using MudBlazor
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject InventoryService InvService
@inject ItemRelationshipService RelService
@inject PickingListService PlService
@inject WorkOrderService WorkOrderService

<MudDialog title="@Title">
    <DialogContent>
        <MudForm @ref="_form" IsReadOnly="@IsProcessing">
            <MudStack Spacing="3">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker Label="Date Issued" Date="Model.CreatedDate" IsReadOnly="true" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker Label="Due Date" @bind-Date="DueDateValue" Required="true" Margin="Margin.Dense" IsReadOnly="@IsProcessing" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="int?" Label="Machine" @bind-Value="MachineId" Required="true" Margin="Margin.Dense" IsReadOnly="@IsProcessing">
                            @foreach (var m in Machines)
                            {
                                <MudSelectItem T="int?" Value="m.Id">@m.Name (@m.Category)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent><MudText Typo="Typo.h6">Pull Info</MudText></CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" sm="3"><MudTextField T="string" Label="Parent Tag #" @bind-Value="Model.TagNumber" Required="true" IsReadOnly="@IsProcessing" /></MudItem>
                            <MudItem xs="12" sm="3"><MudButton Variant="Variant.Outlined" OnClick="SearchByTag" Disabled="@(IsEdit || IsProcessing)" FullWidth="true" Class="mt-4">Search by Tag</MudButton></MudItem>
                            <MudItem xs="12" sm="6"><MudTextField T="string" Label="Parent Item ID" Value="@_parentItem?.ItemId" IsReadOnly="true" /></MudItem>
                            <MudItem xs="12" sm="6"><MudTextField T="string" Label="Description" Value="@_parentItem?.Description" IsReadOnly="true" /></MudItem>
                            <MudItem xs="12" sm="3"><MudTextField T="decimal?" Label="Weight" Value="@_parentItem?.Snapshot" IsReadOnly="true" /></MudItem>
                            <MudItem xs="12" sm="3"><MudTextField T="string" Label="Location" Value="@_parentItem?.Location" IsReadOnly="true" /></MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>

                @if(Model.Items.Any())
                {
                    <MudCard>
                        <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Child Item(s)</MudText></CardHeaderContent></MudCardHeader>
                        <MudCardContent>
                            @foreach(var item in Model.Items)
                            {
                                <MudText><b>@item.ItemCode:</b> @item.Description</MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                }

                <MudCard>
                    <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Skid Setups</MudText></CardHeaderContent></MudCardHeader>
                    <MudCardContent>
                        <MudTable Items="Model.Items" Hover="true" Dense="true">
                            <HeaderContent>
                                <MudTh>#</MudTh>
                                <MudTh>Item ID</MudTh>
                                <MudTh>Picking List #</MudTh>
                                <MudTh>Order Qty</MudTh>
                                <MudTh>Width</MudTh>
                                <MudTh>Length</MudTh>
                                <MudTh>Weight</MudTh>
                                <MudTh>Produced Qty</MudTh>
                                <MudTh>Produced Wt</MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="#">@Model.Items.ToList().IndexOf(context)</MudTd>
                                <MudTd DataLabel="Item ID"><MudTextField @bind-Value="context.ItemCode" Margin="Margin.Dense" IsReadOnly="true" /></MudTd>
                                <MudTd DataLabel="Picking List #"><MudTextField @bind-Value="context.SalesOrderNumber" Margin="Margin.Dense" IsReadOnly="true" /></MudTd>
                                <MudTd DataLabel="Order Qty"><MudTextField @bind-Value="context.OrderQuantity" Margin="Margin.Dense" IsReadOnly="true" /></MudTd>
                                <MudTd DataLabel="Width"><MudTextField @bind-Value="context.Width" Margin="Margin.Dense" IsReadOnly="true" /></Td>
                                <MudTd DataLabel="Length"><MudTextField @bind-Value="context.Length" Margin="Margin.Dense" IsReadOnly="true" /></Td>
                                <MudTd DataLabel="Weight"><MudTextField @bind-Value="context.Weight" Margin="Margin.Dense" IsReadOnly="true" /></Td>
                                <MudTd DataLabel="Produced Qty"><MudTextField @bind-Value="context.ProducedQuantity" Margin="Margin.Dense" IsReadOnly="@(!IsProcessing)" /></Td>
                                <MudTd DataLabel="Produced Wt"><MudTextField @bind-Value="context.ProducedWeight" Margin="Margin.Dense" IsReadOnly="true" /></Td>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveLine(context))" Disabled="@IsProcessing" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>

                <MudTextField T="string" Label="Instructions" @bind-Value="Model.Instructions" Lines="3" IsReadOnly="@IsProcessing" />

                @if(Model.Items.Any(i => i.PickingListItemId.HasValue))
                {
                    <MudCard>
                        <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Ship-To Info</MudText></CardHeaderContent></MudCardHeader>
                        <MudCardContent>
                            @foreach(var pl in Model.Items.Where(i => i.PickingListItemId.HasValue).Select(i => new { i.SalesOrderNumber, i.CustomerName }).Distinct())
                            {
                                <MudText><b>PL:</b> @pl.SalesOrderNumber | <b>Customer:</b> @pl.CustomerName</MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                }

            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        @if (IsProcessing)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="MarkComplete">Mark as Complete</MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;


    [Parameter] public WorkOrder Model { get; set; } = new();
    [Parameter] public List<Machine> Machines { get; set; } = new();
    [Parameter] public List<Branch> Branches { get; set; } = new();
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public bool IsProcessing { get; set; }

    private MudForm? _form;
    private InventoryItem? _parentItem;

    private int? MachineId
    {
        get => Model.MachineId;
        set
        {
            Model.MachineId = value;
            SyncCategoryWithMachine();
        }
    }

    private DateTime? DueDateValue
    {
        get => Model.DueDate;
        set => Model.DueDate = value ?? Model.DueDate;
    }

    protected override void OnParametersSet()
    {
        SyncCategoryWithMachine();
    }

    private void SyncCategoryWithMachine()
    {
        var machine = Machines.FirstOrDefault(m => m.Id == Model.MachineId);
        if (machine != null)
            Model.MachineCategory = machine.Category;
    }

    private async Task SearchByTag()
    {
        if (string.IsNullOrWhiteSpace(Model.TagNumber))
        {
            Snackbar.Add("Please enter a Tag Number.", Severity.Warning);
            return;
        }

        try
        {
            _parentItem = await InvService.GetByTagNumberAsync(Model.TagNumber);
            if (_parentItem is null)
            {
                Snackbar.Add($"Tag '{Model.TagNumber}' not found.", Severity.Error);
                return;
            }
            Model.ParentItemId = _parentItem.ItemId;

            var children = await RelService.GetAsync(_parentItem.ItemId);
            if (children.Count == 0)
            {
                Snackbar.Add($"No child items (sheets) are related to the coil with tag '{Model.TagNumber}'. Use the 'Item Relationships' page to add some.", Severity.Info);
                return;
            }

            // Automatically add child items to the work order
            Model.Items.Clear();
            var childItemIds = new List<string>();
            foreach (var childRel in children)
            {
                var childInv = await InvService.GetByItemIdsAsync(new List<string> { childRel.ChildItemId });
                if (childInv.Any())
                {
                     Model.Items.Add(new WorkOrderItem
                    {
                        ItemCode = childInv.First().ItemId,
                        Description = childInv.First().Description,
                        Width = childInv.First().Width,
                        Length = childInv.First().Length,
                        Weight = childInv.First().Snapshot
                    });
                    childItemIds.Add(childRel.ChildItemId);
                }
            }
            Snackbar.Add($"Automatically added {Model.Items.Count} child item(s).", Severity.Success);
            StateHasChanged();

            // Automatically open the picking list dialog
            var parameters = new DialogParameters
            {
                ["RequiredItemIds"] = childItemIds
            };
            var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
            var dialog = await DialogService.ShowAsync<SelectPickingListDialog>("Select Picking List Items", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is List<PickingListItem> selectedPlItems)
            {
                foreach (var woItem in Model.Items)
                {
                    var matchingPlItem = selectedPlItems.FirstOrDefault(p => p.ItemId == woItem.ItemCode);
                    if (matchingPlItem != null)
                    {
                        woItem.PickingListItemId = matchingPlItem.Id;
                        woItem.SalesOrderNumber = matchingPlItem.PickingList?.SalesOrderNumber;
                        woItem.CustomerName = matchingPlItem.PickingList?.CustomerName;
                        woItem.OrderQuantity = matchingPlItem.Quantity;
                        woItem.Weight = matchingPlItem.Weight; // This was the bug, it was assigning to OrderWeight
                        woItem.Length = matchingPlItem.Length;
                    }
                }
                Snackbar.Add($"Associated {selectedPlItems.Count} picking list item(s).", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        if (_form is not null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        MudDialog.Close(DialogResult.Ok(Model));
    }

    private void RemoveLine(WorkOrderItem item)
    {
        Model.Items.Remove(item);
    }

    private async Task MarkComplete()
    {
        var user = (await AuthState).User;
        var updatedBy = user.Identity?.Name ?? "Unknown";
        await WorkOrderService.MarkWorkOrderCompleteAsync(Model, updatedBy);
        Snackbar.Add("Work Order marked as complete.", Severity.Success);
        MudDialog.Close(DialogResult.Ok(Model));
    }
}
