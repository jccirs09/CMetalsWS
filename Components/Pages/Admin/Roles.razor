@page "/roles"
@using CMetalsWS.Data
@using CMetalsWS.Services
@using MudBlazor
@attribute [Authorize(Roles = "Admin")]

@inject RoleService RoleService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="p-4">
    <MudText Typo="Typo.h5">Roles</MudText>
    <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="AddRole">Add Role</MudButton>
    <MudTable Items="roles" Hover="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Description</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Description">@context.Description</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Color="Color.Info" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditRole(context))"></MudIconButton>
                <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteRole(context))"></MudIconButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<ApplicationRole> roles = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        roles = await RoleService.GetRolesAsync();
    }

    private async Task AddRole()
    {
        var parameters = new DialogParameters
        {
            ["Model"] = new ApplicationRole(),
            ["IsEdit"] = false,
            ["Title"] = "Add Role"
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialogRef = await DialogService.ShowAsync<RoleDialog>("Add Role", parameters, options);
        if (dialogRef is not null)
        {
            var result = await dialogRef.Result;
            if (result is not null && result.Data is ApplicationRole saved)
            {
                var identityResult = await RoleService.CreateRoleAsync(saved);
                if (identityResult.Succeeded)
                {
                    Snackbar.Add("Role created successfully.", Severity.Success);
                    await LoadRoles();
                }
                else
                {
                    Snackbar.Add(identityResult.Errors.FirstOrDefault()?.Description ?? "An error occurred creating the role.", Severity.Error);
                }
            }
        }
    }

    private async Task EditRole(ApplicationRole role)
    {
        var roleToEdit = await RoleService.GetRoleByIdAsync(role.Id);
        if (roleToEdit == null)
        {
            Snackbar.Add("Role not found.", Severity.Error);
            return;
        }

        var parameters = new DialogParameters
        {
            ["Model"] = roleToEdit,
            ["IsEdit"] = true,
            ["Title"] = "Edit Role"
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialogRef = await DialogService.ShowAsync<RoleDialog>("Edit Role", parameters, options);
        if (dialogRef is not null)
        {
            var result = await dialogRef.Result;
            if (result is not null && result.Data is ApplicationRole updated)
            {
                var identityResult = await RoleService.UpdateRoleAsync(updated);
                if (identityResult.Succeeded)
                {
                    Snackbar.Add("Role updated successfully.", Severity.Success);
                    await LoadRoles();
                }
                else
                {
                    Snackbar.Add(identityResult.Errors.FirstOrDefault()?.Description ?? "An error occurred updating the role.", Severity.Error);
                }
            }
        }
    }

    private async Task DeleteRole(ApplicationRole role)
    {
        bool? confirm = await DialogService.ShowMessageBox("Delete Confirmation", $"Delete role '{role.Name}'?", yesText: "Delete", cancelText: "Cancel");
        if (confirm == true)
        {
            await RoleService.DeleteRoleAsync(role.Id);
            Snackbar.Add("Role deleted.", Severity.Success);
            await LoadRoles();
        }
    }
}
